<?xml version="1.0" encoding="UTF-8"?>

<!--
  Keva Windows Installer (MSI)
  WiX v6 - Per-User Installation

  UpgradeCode GUID must NEVER change - it identifies the product family for upgrades.
-->

<Wix xmlns="http://wixtoolset.org/schemas/v4/wxs"
     xmlns:ui="http://wixtoolset.org/schemas/v4/wxs/ui"
     xmlns:util="http://wixtoolset.org/schemas/v4/wxs/util">

  <Package Name="Keva"
           Manufacturer="JungChul Shin"
           Version="$(Version)"
           UpgradeCode="efc1e472-1cb4-4e18-a884-46d38320d154"
           Scope="perUser"
           Language="1033"
           Codepage="1252">

    <!-- Upgrade handling: remove previous versions, block downgrades -->
    <MajorUpgrade DowngradeErrorMessage="A newer version of Keva is already installed."
                  Schedule="afterInstallInitialize" />

    <!-- Use WixUI_Minimal for simple install flow -->
    <ui:WixUI Id="WixUI_Minimal" />
    <WixVariable Id="WixUILicenseRtf" Value="LICENSE.rtf" />

    <!-- Media for cabinet files -->
    <Media Id="1" Cabinet="keva.cab" EmbedCab="yes" />

    <!-- Launch Keva checkbox on exit dialog -->
    <Property Id="WIXUI_EXITDIALOGOPTIONALCHECKBOXTEXT" Value="Launch Keva" />
    <Property Id="WIXUI_EXITDIALOGOPTIONALCHECKBOX" Value="1" />
    <Property Id="WixShellExecTarget" Value="[#KevaExe]" />

    <!-- Installation directory: %LOCALAPPDATA%\Programs\Keva -->
    <StandardDirectory Id="LocalAppDataFolder">
      <Directory Id="LocalProgramsFolder" Name="Programs">
        <Directory Id="INSTALLFOLDER" Name="Keva">
          <Component Id="MainExecutable" Guid="a1099f9e-cfcb-4032-83ba-efeceef39bc0">
            <File Id="KevaExe" Source="$(ExePath)" Name="keva_windows.exe" KeyPath="yes" />
          </Component>
          <Directory Id="DistFolder" Name="dist" />
        </Directory>
      </Directory>
    </StandardDirectory>

    <!-- Start Menu shortcut -->
    <StandardDirectory Id="ProgramMenuFolder">
      <Directory Id="ApplicationProgramsFolder" Name="Keva">
        <Component Id="StartMenuShortcut" Guid="358b17ab-145f-4fc2-b6ad-6a5144d4ca73">
          <Shortcut Id="ApplicationStartMenuShortcut"
                    Name="Keva"
                    Description="Local key-value store for knowledge management"
                    Target="[#KevaExe]"
                    WorkingDirectory="INSTALLFOLDER" />
          <RemoveFolder Id="CleanupStartMenuFolder" On="uninstall" />
          <RegistryValue Root="HKCU" Key="Software\Keva" Name="StartMenuShortcut" Type="integer" Value="1" KeyPath="yes" />
        </Component>
      </Directory>
    </StandardDirectory>

    <!-- Installer marker -->
    <Component Id="InstallerMarker" Guid="2aee32aa-7ce4-4f2b-90ea-c45ea04a1f86" Directory="INSTALLFOLDER">
      <RegistryValue Root="HKCU" Key="Software\Keva" Name="InstallerMarker" Type="integer" Value="1" KeyPath="yes" />
    </Component>

    <!-- Feature definition -->
    <Feature Id="ProductFeature" Title="Keva" Level="1">
      <ComponentRef Id="MainExecutable" />
      <ComponentGroupRef Id="DistFiles" />
      <ComponentRef Id="StartMenuShortcut" />
      <ComponentRef Id="InstallerMarker" />
    </Feature>

    <!-- Launch application after install -->
    <CustomAction Id="LaunchApplication"
                  DllEntry="WixShellExec"
                  Impersonate="yes"
                  BinaryRef="Wix4UtilCA_X86" />

    <!--
      Unregister startup entry on uninstall.
      Calls the exe with unregister-startup flag. (double dashes)
      Skipped during upgrade (UPGRADINGPRODUCTCODE) to preserve user preference.
    -->
    <SetProperty Id="UnregisterStartup"
                 Value="&quot;[INSTALLFOLDER]keva_windows.exe&quot; --unregister-startup"
                 Before="UnregisterStartup"
                 Sequence="execute" />

    <CustomAction Id="UnregisterStartup"
                  DllEntry="WixQuietExec"
                  BinaryRef="Wix4UtilCA_X86"
                  Execute="deferred"
                  Impersonate="yes"
                  Return="ignore" />

    <!-- Schedule custom actions -->
    <InstallExecuteSequence>
      <Custom Action="UnregisterStartup" Before="RemoveFiles"
              Condition="Installed AND REMOVE=&quot;ALL&quot; AND NOT UPGRADINGPRODUCTCODE" />
    </InstallExecuteSequence>

    <!-- Launch Keva when user clicks Finish with checkbox checked -->
    <UI>
      <Publish Dialog="ExitDialog" Control="Finish" Event="DoAction" Value="LaunchApplication"
               Condition="WIXUI_EXITDIALOGOPTIONALCHECKBOX = 1 AND NOT Installed" />
    </UI>

  </Package>

  <!-- WebView UI files (Vite build output) -->
  <Fragment>
    <ComponentGroup Id="DistFiles" Directory="DistFolder">
      <Files Include="$(DistPath)\**" />
    </ComponentGroup>
  </Fragment>
</Wix>
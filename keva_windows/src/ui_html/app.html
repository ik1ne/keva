<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --bg-primary: #1a1a1a;
            --bg-secondary: #252526;
            --bg-tertiary: #2d2d2d;
            --bg-input: #3c3c3c;
            --bg-hover: #2a2d2e;
            --bg-selected: #094771;
            --bg-header: #1e1e1e;
            --text-primary: #d4d4d4;
            --text-secondary: #969696;
            --text-muted: #808080;
            --border-color: #3c3c3c;
            --accent-color: #007acc;
        }

        :root[data-theme="light"] {
            --bg-primary: #ffffff;
            --bg-secondary: #f3f3f3;
            --bg-tertiary: #e8e8e8;
            --bg-input: #ffffff;
            --bg-hover: #e8e8e8;
            --bg-selected: #0060c0;
            --bg-header: #f0f0f0;
            --text-primary: #1e1e1e;
            --text-secondary: #616161;
            --text-muted: #767676;
            --border-color: #d4d4d4;
            --accent-color: #0066b8;
        }

        html, body {
            height: 100%;
            overflow: hidden;
            background: var(--bg-primary);
            font-family: 'Segoe UI', sans-serif;
            color: var(--text-primary);
            user-select: none;
        }

        .app {
            display: flex;
            flex-direction: column;
            height: 100%;
        }

        /* Search bar */
        .search-bar {
            display: flex;
            align-items: center;
            height: 48px;
            padding: 4px;
            gap: 4px;
            flex-shrink: 0;
        }

        .search-icon {
            width: 40px;
            height: 40px;
            background: var(--bg-tertiary);
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            color: var(--text-secondary);
            flex-shrink: 0;
            -webkit-app-region: drag;
            app-region: drag;
        }

        .search-input {
            flex: 1;
            background: var(--bg-input);
            border: 1px solid var(--border-color);
            border-radius: 4px;
            padding: 8px 12px;
            color: var(--text-primary);
            font-size: 14px;
            outline: none;
            -webkit-app-region: no-drag;
            app-region: no-drag;
        }

        .search-input:focus {
            border-color: var(--accent-color);
        }

        .search-input::placeholder {
            color: var(--text-muted);
        }

        .search-action-btn {
            width: 40px;
            height: 40px;
            background: var(--bg-tertiary);
            border: none;
            border-radius: 4px;
            display: none;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            color: var(--text-secondary);
            cursor: pointer;
            flex-shrink: 0;
        }

        .search-action-btn:hover {
            background: var(--bg-input);
            color: var(--text-primary);
        }

        .search-action-btn.visible {
            display: flex;
        }

        /* Main content */
        .main-content {
            display: flex;
            flex: 1;
            overflow: hidden;
        }

        .left-pane {
            width: 250px;
            min-width: 150px;
            background: var(--bg-secondary);
            border-right: 1px solid var(--border-color);
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .key-list {
            flex: 1;
            overflow-y: auto;
            padding: 4px 0;
        }

        .key-item {
            padding: 8px 16px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .key-item:hover {
            background: var(--bg-hover);
        }

        .key-item.selected {
            background: var(--bg-selected);
            color: #ffffff;
        }

        .key-name {
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .key-actions {
            display: none;
            gap: 4px;
        }

        .key-item:hover .key-actions {
            display: flex;
        }

        .key-action-btn {
            background: none;
            border: none;
            color: var(--text-muted);
            cursor: pointer;
            padding: 2px 4px;
            font-size: 12px;
        }

        .key-action-btn:hover {
            color: var(--text-primary);
        }

        .trash-section {
            display: none;
            border-top: 1px solid var(--border-color);
            max-height: 120px;
            overflow-y: auto;
        }

        .trash-header {
            padding: 8px 16px;
            font-size: 12px;
            color: var(--text-muted);
            background: var(--bg-header);
            position: sticky;
            top: 0;
        }

        .trash-item {
            padding: 6px 16px;
            cursor: pointer;
            display: flex;
            align-items: center;
            font-size: 13px;
            color: var(--text-muted);
        }

        .trash-item:hover {
            background: var(--bg-hover);
        }

        .trash-icon {
            margin-right: 8px;
        }

        .right-pane {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        #editor-container {
            flex: 1;
            display: none;
            overflow: hidden;
        }

        .empty-state {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--text-muted);
            font-size: 14px;
        }

        .splash {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: var(--bg-primary);
            display: flex;
            align-items: center;
            justify-content: center;
            flex-direction: column;
            z-index: 9999;
            transition: opacity 0.15s ease-out;
        }

        .splash.hidden {
            opacity: 0;
            pointer-events: none;
        }

        .splash-text {
            color: var(--text-muted);
            font-size: 14px;
        }
    </style>
</head>
<body>
<div class="splash" id="splash">
    <div class="splash-text">Loading database...</div>
</div>
<div class="app">
    <div class="search-bar">
        <div class="search-icon">&#128269;</div>
        <input type="text" class="search-input" id="search-input" placeholder="Search keys...">
        <button class="search-action-btn" id="search-action-btn" title="Create or edit">&#43;</button>
    </div>
    <div class="main-content">
        <div class="left-pane">
            <div class="key-list" id="key-list"></div>
            <div class="trash-section" id="trash-section">
                <div class="trash-header">Trash (<span id="trash-count">0</span>)</div>
                <div id="trash-list"></div>
            </div>
        </div>
        <div class="right-pane">
            <div id="editor-container"></div>
            <div class="empty-state" id="empty-state">
                Select a key or type to search
            </div>
        </div>
    </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.45.0/min/vs/loader.min.js"></script>
<script>
    const searchInput = document.getElementById('search-input');
    const searchActionBtn = document.getElementById('search-action-btn');
    let editor = null;
    let selectedKey = null;
    let isSelectedTrashed = false;
    let keys = [];
    let trashedKeys = [];
    let isDirty = false;
    let saveTimer = null;
    let isShuttingDown = false;
    let pendingSelectKey = null;
    let exactMatch = 'none'; // 'none' | 'active' | 'trashed'

    function sendToNative(msg) {
        window.chrome.webview.postMessage(JSON.stringify(msg));
    }

    document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape') {
            sendToNative({type: 'hide'});
        }
    });

    searchInput.addEventListener('input', (e) => {
        if (e.target.value && selectedKey) {
            selectedKey = null;
            updateSelection();
        }
        updateSearchButton();
        sendToNative({type: 'search', query: e.target.value});
    });

    function updateSearchButton() {
        const query = searchInput.value.trim();
        if (!query || selectedKey) {
            searchActionBtn.classList.remove('visible');
            return;
        }

        // Use exactMatch from SearchEngine (O(1) lookup, guaranteed accurate)
        if (exactMatch !== 'none') {
            searchActionBtn.innerHTML = '&#9998;';
            searchActionBtn.title = 'Edit key';
        } else {
            searchActionBtn.innerHTML = '&#43;';
            searchActionBtn.title = 'Create key';
        }
        searchActionBtn.classList.add('visible');
    }

    searchActionBtn.addEventListener('click', () => {
        const query = searchInput.value.trim();
        if (!query) return;

        // Use exactMatch for reliable existence check
        if (exactMatch !== 'none') {
            selectKey(query);
        } else {
            sendToNative({type: 'create', key: query});
        }
        searchInput.value = '';
        updateSearchButton();
    });

    searchInput.addEventListener('keydown', (e) => {
        if (e.key === 'Enter') {
            const query = searchInput.value.trim();
            if (query) {
                // Use exactMatch for reliable existence check
                if (exactMatch !== 'none') {
                    selectKey(query);
                } else {
                    pendingSelectKey = query;
                    sendToNative({type: 'create', key: query});
                }
            }
        } else if (e.key === 'ArrowDown') {
            e.preventDefault();
            focusKeyList();
        }
    });

    function focusKeyList() {
        const firstItem = document.querySelector('.key-item');
        if (firstItem) {
            firstItem.focus();
        }
    }

    require.config({paths: {'vs': 'https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.45.0/min/vs'}});
    require(['vs/editor/editor.main'], function () {
        editor = monaco.editor.create(document.getElementById('editor-container'), {
            value: '',
            language: 'plaintext',
            theme: 'vs-dark',
            automaticLayout: true,
            minimap: {enabled: false},
            fontSize: 14,
            wordWrap: 'on',
            scrollBeyondLastLine: false
        });

        editor.onDidChangeModelContent(() => {
            if (selectedKey) {
                isDirty = true;
                scheduleSave();
            }
        });

        sendToNative({type: 'ready'});
    });

    const keyList = document.getElementById('key-list');
    const trashSection = document.getElementById('trash-section');
    const trashList = document.getElementById('trash-list');
    const trashCount = document.getElementById('trash-count');
    const editorContainer = document.getElementById('editor-container');
    const emptyState = document.getElementById('empty-state');

    function scheduleSave() {
        if (saveTimer) clearTimeout(saveTimer);
        saveTimer = setTimeout(() => {
            if (isDirty && selectedKey && editor) {
                sendToNative({
                    type: 'save',
                    key: selectedKey,
                    content: editor.getValue()
                });
                isDirty = false;
            }
        }, 3000);
    }

    function forceSave() {
        if (saveTimer) clearTimeout(saveTimer);
        if (isDirty && selectedKey && editor) {
            sendToNative({
                type: 'save',
                key: selectedKey,
                content: editor.getValue()
            });
            isDirty = false;
        }
    }

    let currentTheme = 'dark';
    const splash = document.getElementById('splash');

    function hideSplash() {
        if (splash && !splash.classList.contains('hidden')) {
            splash.classList.add('hidden');
            setTimeout(() => splash.remove(), 150);
        }
    }

    function applyTheme(theme) {
        currentTheme = theme;
        document.documentElement.setAttribute('data-theme', theme);
        if (editor) {
            monaco.editor.setTheme(theme === 'light' ? 'vs' : 'vs-dark');
        }
    }

    window.chrome.webview.addEventListener('message', event => {
        const msg = event.data;

        switch (msg.type) {
            case 'coreReady':
                hideSplash();
                break;

            case 'theme':
                applyTheme(msg.theme);
                break;

            case 'keyCreated':
                if (!msg.success) {
                    alert('Key already exists: ' + msg.key);
                    pendingSelectKey = null;
                }
                break;

            case 'value':
                // Ignore stale responses from previously selected keys
                if (msg.key !== selectedKey) break;
                if (msg.value) {
                    if (msg.value.type === 'text') {
                        showEditor(msg.value.content);
                    } else if (msg.value.type === 'files') {
                        showEmptyState(`${msg.value.count} file(s)`);
                    }
                } else {
                    showEmptyState('Key not found');
                }
                break;

            case 'searchResults':
                keys = msg.keys.filter(k => !k.trashed);
                trashedKeys = msg.keys.filter(k => k.trashed);
                exactMatch = msg.exactMatch;
                renderKeyList();
                renderTrashList();
                updateSearchButton();
                if (pendingSelectKey) {
                    selectKey(pendingSelectKey);
                    pendingSelectKey = null;
                }
                break;

            case 'shutdown':
                if (isShuttingDown) {
                    sendToNative({type: 'shutdownAck'});
                    break;
                }
                isShuttingDown = true;
                showShutdownOverlay();
                forceSave();
                sendToNative({type: 'shutdownAck'});
                break;

            case 'focus':
                searchInput.focus();
                break;
        }
    });

    function renderKeyList() {
        keyList.innerHTML = keys.map(key => `
            <div class="key-item" data-key="${escapeHtml(key.name)}" onclick="selectKey('${escapeJs(key.name)}')">
                <span class="key-name">${escapeHtml(key.name)}</span>
                <div class="key-actions">
                    <button class="key-action-btn" onclick="event.stopPropagation(); renameKey('${escapeJs(key.name)}')" title="Rename">&#9998;</button>
                    <button class="key-action-btn" onclick="event.stopPropagation(); deleteKey('${escapeJs(key.name)}')" title="Delete">&#128465;</button>
                </div>
            </div>
        `).join('');
        updateSelection();
    }

    function renderTrashList() {
        if (trashedKeys.length === 0) {
            trashSection.style.display = 'none';
            return;
        }
        trashSection.style.display = 'block';
        trashCount.textContent = trashedKeys.length;
        trashList.innerHTML = trashedKeys.map(key => `
            <div class="trash-item" onclick="selectKey('${escapeJs(key.name)}')">
                <span class="trash-icon">T</span>
                <span class="key-name">${escapeHtml(key.name)}</span>
            </div>
        `).join('');
    }

    function updateSelection() {
        document.querySelectorAll('.key-item').forEach(el => {
            el.classList.toggle('selected', el.dataset.key === selectedKey);
        });
    }

    function selectKey(keyName) {
        if (isDirty && selectedKey) {
            forceSave();
        }
        selectedKey = keyName;
        isSelectedTrashed = trashedKeys.some(k => k.name === keyName);
        updateSelection();
        updateSearchButton();
        // Clear right pane while loading
        showEmptyState('Loading...');
        sendToNative({type: 'select', key: keyName});
    }

    function renameKey(keyName) {
        const newName = prompt('Rename key:', keyName);
        if (newName && newName !== keyName) {
            sendToNative({type: 'rename', oldKey: keyName, newKey: newName});
        }
    }

    function deleteKey(keyName) {
        sendToNative({type: 'trash', key: keyName});
    }

    function showEditor(content) {
        emptyState.style.display = 'none';
        editorContainer.style.display = 'block';
        if (editor) {
            editor.setValue(content || '');
            editor.updateOptions({ readOnly: isSelectedTrashed });
            isDirty = false;
            editor.focus();
        }
    }

    function showEmptyState(message) {
        emptyState.textContent = message || 'Select a key or type to search';
        emptyState.style.display = 'flex';
        editorContainer.style.display = 'none';
    }

    function showShutdownOverlay() {
        const overlay = document.createElement('div');
        overlay.style.cssText = 'position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.3);z-index:9999;';
        document.body.appendChild(overlay);
    }

    function escapeHtml(str) {
        return str.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;');
    }

    function escapeJs(str) {
        return str.replace(/\\/g, '\\\\').replace(/'/g, "\\'");
    }

    searchInput.focus();
    showEmptyState();
</script>
</body>
</html>

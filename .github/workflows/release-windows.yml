name: Release Windows

on:
  push:
    branches: [ main ]
  workflow_dispatch:
    inputs:
      skip_release:
        description: 'Build only (no GitHub Release)'
        type: boolean
        default: false

jobs:
  build:
    runs-on: windows-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Extract version
        id: version
        shell: pwsh
        run: |
          $version = ./scripts/windows/extract-version.ps1
          echo "version=$version" >> $env:GITHUB_OUTPUT
          echo "Version: $version"

      - name: Check existing release
        id: check_release
        if: github.event_name == 'push'
        shell: pwsh
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          $tag = "windows-v${{ steps.version.outputs.version }}"
          $null = gh release view $tag 2>&1
          if ($LASTEXITCODE -eq 0) {
            echo "exists=true" >> $env:GITHUB_OUTPUT
            echo "Release $tag already exists, skipping build"
          } else {
            echo "exists=false" >> $env:GITHUB_OUTPUT
            echo "Release $tag does not exist, proceeding with build"
            exit 0  # Explicitly exit with success
          }

      - name: Setup Rust
        if: steps.check_release.outputs.exists != 'true'
        uses: dtolnay/rust-toolchain@stable

      - name: Setup pnpm
        if: steps.check_release.outputs.exists != 'true'
        uses: pnpm/action-setup@v4
        with:
          version: 10

      - name: Setup Node.js
        if: steps.check_release.outputs.exists != 'true'
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'pnpm'
          cache-dependency-path: keva_windows/src/webview/vite/pnpm-lock.yaml

      - name: Build
        if: steps.check_release.outputs.exists != 'true'
        shell: pwsh
        run: ./scripts/windows/build.ps1 -Release

      - name: Upload artifact
        if: steps.check_release.outputs.exists != 'true'
        uses: actions/upload-artifact@v4
        with:
          name: keva-windows-${{ steps.version.outputs.version }}-x64
          path: target/release/keva_windows.exe

      # TODO: Build MSI installer (Phase 3)
      # - name: Build installer
      #   run: ./scripts/windows/build-installer.ps1

      # TODO: Uncomment when ready for actual releases
      # - name: Create release
      #   if: |
      #     steps.check_release.outputs.exists != 'true' &&
      #     (github.event_name == 'push' || !inputs.skip_release)
      #   env:
      #     GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      #   shell: pwsh
      #   run: |
      #     $version = "${{ steps.version.outputs.version }}"
      #     $tag = "windows-v$version"
      #
      #     # For now, upload exe directly. Will be MSI in Phase 3.
      #     gh release create $tag `
      #       --title "Keva Windows v$version" `
      #       --generate-notes `
      #       target/release/keva_windows.exe#keva-windows-$version-x64.exe
